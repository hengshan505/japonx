#!name=Surge 全能通用增强模块 V2
#!desc=针对日志报错优化：整合 Google重定向 + 常用端口过滤 + 增强型跳过代理 + 稳定DNS。修复了京东与车来了的证书冲突(Certificate Pinning)。
#!category=Custom

[General]
# > 优化 DNS 稳定性 (解决日志中的 DoH 频繁超时问题)
dns-server = %APPEND% 223.5.5.5, 119.29.29.29, 114.114.114.114

# > 跳过代理 (Skip Proxy) - 整合银行、一键登录及局域网，确保日志中那些检测不走代理
skip-proxy = %APPEND% localhost, *.local, captive.apple.com, e.crashlytics.com, www.baidu.com, passenger.t3go.cn, yunbusiness.ccb.com, wxh.wo.cn, gate.lagou.com, www.abchina.com.cn, login-service.mobile-bank.psbc.com, mobile-bank.psbc.com, www.shanbay.com, id6.me, www.163.com, 10.0.0.0/8, 127.0.0.1/32, 172.16.0.0/12, 192.168.0.0/16, ::1/128, fe80::/10

# > Always Real IP - 解决一键登录和特定检测失败
always-real-ip = %APPEND% *.lan, *.direct, cable.auth.com, *.msftconnecttest.com, *.msftncsi.com, detectportal.firefox.com, *.srv.nintendo.net, *.stun.playstation.net, xbox.*.microsoft.com, *.xboxlive.com, app.yinxiang.com, music.163.com, *.music.163.com, *.126.net, y.qq.com, *.y.qq.com, *.xiami.com, *.music.migu.cn, id6.me, open.e.189.cn, easy-login.10099.com.cn, *-update.xoyocdn.com, pool.ntp.org, *.pool.ntp.org, time.*.com, ntp.*.com

[Rule]
# > 常用端口过滤 (来自 dler-io) - 解决非标准端口连接被拒
AND,((NOT,((DEST-PORT,21))),(NOT,((DEST-PORT,22))),(NOT,((DEST-PORT,23))),(NOT,((DEST-PORT,53))),(NOT,((DEST-PORT,80))),(NOT,((DEST-PORT,123))),(NOT,((DEST-PORT,194))),(NOT,((DEST-PORT,443))),(NOT,((DEST-PORT,465))),(NOT,((DEST-PORT,587))),(NOT,((DEST-PORT,853))),(NOT,((DEST-PORT,993))),(NOT,((DEST-PORT,995))),(NOT,((DEST-PORT,998))),(NOT,((DEST-PORT,2052))),(NOT,((DEST-PORT,2053))),(NOT,((DEST-PORT,2082))),(NOT,((DEST-PORT,2083))),(NOT,((DEST-PORT,2086))),(NOT,((DEST-PORT,2095))),(NOT,((DEST-PORT,2096))),(NOT,((DEST-PORT,3389))),(NOT,((DEST-PORT,5222))),(NOT,((DEST-PORT,5228))),(NOT,((DEST-PORT,5229))),(NOT,((DEST-PORT,5230))),(NOT,((DEST-PORT,8080))),(NOT,((DEST-PORT,8443))),(NOT,((DEST-PORT,8880))),(NOT,((DEST-PORT,8888))),(NOT,((DEST-PORT,8889))),(NOT,((DEST-PORT,52000)))),DIRECT

# > 农行特定拦截
DOMAIN,msmp.abchina.com.cn,REJECT

[URL Rewrite]
# > Google 重定向 (来自 limbopro)
^https?://(www.)?g.cn https://www.google.com 302
^https?://(www.)?google.cn https://www.google.com 302

[MITM]
# > MITM 增强 - 明确排除京东与车来了，解决日志中的 TLS Handshake 失败
hostname = %APPEND% www.google.cn, www.g.cn, -*.facebook.com, -*.instagram.com, -*.twitter.com, -*.snssdk.com, -*.pstatp.com, -*.360buyimg.com, -*.m.jd.com, -*.chelaileapp.cn

# > 禁用特定域名的 MitM 以防连接断开 (来自 Fries)
hostname-disabled = %APPEND% gateway.icloud.com, gateway.icloud.com.cn, weather-data.apple.com, buy.itunes.apple.com, ios.chat.openai.com
